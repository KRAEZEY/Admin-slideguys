<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>

  <!-- Replacing the problematic Font Awesome kit with CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f8f8;
      margin: 0;
      padding: 2rem;
    }

    h1 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .toolbar {
      margin-bottom: 1rem;
    }

    button {
      margin-right: 1rem;
      cursor: pointer;
    }

    #calendar {
      max-width: 900px;
      margin: 40px auto;
      display: none;
    }
  </style>
</head>
<body>
  <h1><i class="fas fa-clipboard-list"></i> Admin Dashboard</h1>

  <div class="toolbar">
    <button id="toggleCalendar"><i class="fas fa-calendar-alt"></i> View Bookings Calendar</button>
    Filter by Unit:
    <select id="unitFilter">
      <option value="all">All Units</option>
    </select>
    <button id="logoutBtn" style="float: right;"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </div>

  <div id="calendar"></div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    const supabaseUrl = 'https://vaobmohukgcqfvnclqyh.supabase.co'
    const supabaseKey = 'YOUR_SUPABASE_KEY'
    const supabase = createClient(supabaseUrl, supabaseKey)

    const calendarEl = document.getElementById('calendar')
    const toggleBtn = document.getElementById('toggleCalendar')
    const unitFilter = document.getElementById('unitFilter')
    let calendar

    async function loadUnits() {
      const { data, error } = await supabase.from('units').select('*')
      if (data) {
        data.forEach(unit => {
          const opt = document.createElement('option')
          opt.value = unit.id
          opt.textContent = unit.name
          unitFilter.appendChild(opt)
        })
      }
    }

    async function loadBookings(unitId = 'all') {
      let query = supabase.from('bookings').select('id, date, unit_id, customer_name')
      if (unitId !== 'all') {
        query = query.eq('unit_id', unitId)
      }
      const { data, error } = await query
      if (data) {
        const events = data.map(booking => ({
          id: booking.id,
          title: `Booking: ${booking.customer_name}`,
          start: booking.date,
          allDay: true
        }))
        calendar.removeAllEvents()
        calendar.addEventSource(events)
      }
    }

    toggleBtn.addEventListener('click', () => {
      calendarEl.style.display = calendarEl.style.display === 'none' ? 'block' : 'none'
      calendar.render()
    })

    unitFilter.addEventListener('change', () => {
      const unitId = unitFilter.value
      loadBookings(unitId)
    })

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut()
      window.location.reload()
    })

    document.addEventListener('DOMContentLoaded', async function () {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
        const email = prompt("Email:")
        const password = prompt("Password:")
        const { error } = await supabase.auth.signInWithPassword({ email, password })
        if (error) {
          alert('Login failed')
          return
        }
      }

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 650,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: ''
        },
        eventClick: function(info) {
          alert('Booking ID: ' + info.event.id)
        }
      })
      calendar.render()

      await loadUnits()
      await loadBookings()
    })
  </script>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
</body>
</html>
